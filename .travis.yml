language: php

services:
  - docker

env:
  global:
    # The module name to be mounted and tested in the Docker.
    - MODULE_NAME="bamboo_twig"

matrix:
  include:
    - name: Drupal 8.8.x
      env: BASE_IMAGE_TAG="8.8"
    - name: Drupal 8.9.x
      env: BASE_IMAGE_TAG="8.9"
    - name: Drupal 9.0.x
      env: BASE_IMAGE_TAG="9.0"
    - name: Drupal 9.1.x
      env: BASE_IMAGE_TAG="9.1"
    - name: Drupal 9.2.x-dev
      env: BASE_IMAGE_TAG="9.2"

jobs:
  allow_failures:
    - env: BASE_IMAGE_TAG="9.1"
    - env: BASE_IMAGE_TAG="9.2"

before_install:
  - docker-compose build --pull --build-arg BASE_IMAGE_TAG=${BASE_IMAGE_TAG} drupal
  - docker-compose up -d drupal
  # wait on Docker to be ready, especially MariaDB that takes many seconds to be up.
  - docker-compose exec drupal wait-for-it drupal:80 -t 60
  - docker-compose exec drupal wait-for-it db:3306 -t 60

script:
  - docker-compose exec -u www-data drupal phpunit --no-coverage --group=${MODULE_NAME} --configuration=/var/www/html/phpunit.xml
